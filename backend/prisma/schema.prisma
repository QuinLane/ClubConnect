generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  userID                Int                     @id @default(autoincrement())
  userType              UserType
  username              String                  @unique
  email                 String                  @unique
  passwordHash          String
  forms                 Form[]
  createdAt             DateTime                @default(now())
  executives            Executive[]
  rsvps                 RSVP[]
  sentMessages          SUMessage[]             @relation("SentMessages")
  receivedMessages      SUMessage[]             @relation("ReceivedMessages")
  sentNotifications     Notification[]          @relation("SentNotifications")
  receivedNotifications NotificationRecipient[] @relation("ReceivedNotifications")
  presidentClubs        Club[]                  @relation("ClubPresident")
  memberships           MemberOf[]              @relation("UserMemberships")
}

model MemberOf {
  userID Int
  clubID Int
  user   User @relation("UserMemberships", fields: [userID], references: [userID])
  club   Club @relation("ClubMembers", fields: [clubID], references: [clubID])

  @@id([userID, clubID])
}

model Club {
  clubID           Int            @id @default(autoincrement())
  clubName         String         @unique
  description      String?
  createdAt        DateTime       @default(now())
  president        Int
  presidentUser    User           @relation("ClubPresident", fields: [president], references: [userID])
  executives       Executive[]
  members          MemberOf[]     @relation("ClubMembers")
  events           Event[]
  notifications    Notification[] @relation("ClubNotifications")
  socialMediaLinks String?
  website          String?
  clubEmail        String?
  image            Bytes?
}

model Executive {
  userID Int
  clubID Int
  role   String?
  user   User    @relation(fields: [userID], references: [userID])
  club   Club    @relation(fields: [clubID], references: [clubID])

  @@id([clubID, userID])
}

model RSVP {
  rsvpID  Int   @id @default(autoincrement())
  userID  Int
  eventID Int
  user    User  @relation(fields: [userID], references: [userID])
  event   Event @relation(fields: [eventID], references: [eventID])

  @@unique([userID, eventID])
}

model Form {
  formID      Int        @id @default(autoincrement())
  userID      Int
  formType    FormType
  status      FormStatus @default(Pending)
  submittedAt DateTime   @default(now())
  details     String?
  user        User       @relation(fields: [userID], references: [userID])
}

model SUMessage {
  messageID  Int      @id @default(autoincrement())
  senderID   Int? // Null for SU messages
  receiverID Int? // Null for messages to SU, userID for SU replies
  content    String
  sentAt     DateTime @default(now())
  isRead     Boolean  @default(false)
  isActive   Boolean  @default(true) //tracks if the message thread is active
  threadID   Int // Groups messages into a thread
  sender     User?    @relation("SentMessages", fields: [senderID], references: [userID])
  receiver   User?    @relation("ReceivedMessages", fields: [receiverID], references: [userID])
}

model Notification {
  notificationID Int                     @id @default(autoincrement())
  title          String
  content        String
  postedAt       DateTime                @default(now())
  senderID       Int
  clubID         Int? // Optional, for club-specific notifications
  sender         User                    @relation("SentNotifications", fields: [senderID], references: [userID])
  club           Club?                   @relation("ClubNotifications", fields: [clubID], references: [clubID])
  recipients     NotificationRecipient[] @relation("NotificationRecipients")
}

model NotificationRecipient {
  notificationID Int
  userID         Int
  isRead         Boolean      @default(false)
  notification   Notification @relation("NotificationRecipients", fields: [notificationID], references: [notificationID])
  user           User         @relation("ReceivedNotifications", fields: [userID], references: [userID])

  @@id([notificationID, userID])
}

model Venue {
  venueID      Int           @id @default(autoincrement())
  name         String        @unique
  capacity     Int
  address      String
  type         String?
  openHours    String? // E.g., "9:00-17:00"
  reservations Reservation[]
}

model Event {
  eventID     Int          @id @default(autoincrement())
  name        String
  description String
  clubID      Int
  club        Club         @relation(fields: [clubID], references: [clubID], onDelete: Cascade)
  reservation Reservation?
  rsvps       RSVP[]
  image       Bytes?

  @@map("event")
}

model Reservation {
  reservationID Int      @id @default(autoincrement())
  date          DateTime
  startTime     Int
  endTime       Int
  venueID       Int
  venue         Venue    @relation(fields: [venueID], references: [venueID], onDelete: Cascade)
  eventID       Int      @unique
  event         Event    @relation(fields: [eventID], references: [eventID])

  @@unique([venueID, date, startTime, endTime])
}

enum UserType {
  Student
  SUAdmin
}

enum FormType {
  ClubCreation
  EventApproval
  Funding
  DeleteClub
}

enum FormStatus {
  Pending
  Approved
  Rejected
}
